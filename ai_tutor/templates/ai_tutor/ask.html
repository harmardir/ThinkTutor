{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ThinkTutor – Ask AI</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
        body {
            background-image: url("{% static 'images/background.png' %}");
            background-size: cover;
            background-repeat: no-repeat;
        }
         .chat-container {
            max-width: 700px;
            margin: 30px auto;
            padding: 20px;
            border-radius: 10px;
            background: #f8f9fa;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
            width: 90%;
            box-sizing: border-box;
        }
        .chat-bubble {
            padding: 10px 15px;
            border-radius: 20px;
            margin-bottom: 10px;
            max-width: 80%;
            word-wrap: break-word;
        }
        .user {
            background-color: #0d6efd;
            color: white;
            align-self: flex-end;
        }
        .ai {
            background-color: #e2e3e5;
            color: black;
            align-self: flex-start;
        }
        .chat-log {
            display: flex;
            flex-direction: column;
        }

        @media (max-width: 600px) {
            .chat-container {
                margin: 15px auto;
                padding: 15px;
            }

            .chat-bubble {
                max-width: 100%;
                font-size: 14px;
                padding: 8px 12px;
            }

            #ask-form {
                flex-direction: column;
            }

            #ask-form input,
            #ask-form button {
                width: 100%;
                margin: 5px 0;
            }
        }
    </style>
</head>
<body>
<div class="container chat-container">
    <h2 class="text-center mb-4">ThinkTutor – AI Learning Assistant</h2>

    <div id="chat-log" class="chat-log mb-4"></div>
    <button id="clear-chat" class="btn btn-secondary mb-4">Clear Chat</button>

    <form id="ask-form" method="post" class="d-flex">
        {% csrf_token %}
        <input type="text" name="question" class="form-control me-2" placeholder="Ask a question..." required />
        <button type="submit" class="btn btn-primary">Ask</button>
    </form>
</div>
<script>
    const form = document.getElementById("ask-form");
    const chatLog = document.getElementById("chat-log");

    let loadingBubble = null;

    // Show loading spinner bubble in chat
    function showLoading() {
        loadingBubble = document.createElement("div");
        loadingBubble.className = "chat-bubble ai align-self-start d-flex align-items-center";

        loadingBubble.innerHTML = `
            <div class="spinner-border spinner-border-sm text-primary me-2" role="status"></div>
            <span>AI is thinking...</span>
        `;

        chatLog.appendChild(loadingBubble);
        chatLog.scrollTop = chatLog.scrollHeight;
    }

    // Remove loading spinner bubble
    function hideLoading() {
        if (loadingBubble) {
            chatLog.removeChild(loadingBubble);
            loadingBubble = null;
        }
    }

    // Add a chat bubble with optional timestamp
    function addChatBubble(type, text, timestampISO = null) {
        const bubble = document.createElement("div");
        bubble.className = `chat-bubble ${type}`;

        const dateObj = timestampISO ? new Date(timestampISO) : new Date();
        const timestamp = dateObj.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

        bubble.innerHTML = `<span>${text}</span><br><small style="font-size: 0.7em; color: gray;">${timestamp}</small>`;
        chatLog.appendChild(bubble);
        chatLog.scrollTop = chatLog.scrollHeight;
    }

    // Queue a question in localStorage with timestamp and csrf token
    function queueQuestion(question, csrfToken) {
        const queue = JSON.parse(localStorage.getItem("offlineQueue") || "[]");
        const timestamp = new Date().toISOString();
        queue.push({ question, csrfToken, timestamp });
        localStorage.setItem("offlineQueue", JSON.stringify(queue));
    }

    // Send a queued question to the server
    async function sendQuestion(question, csrfToken) {
        const formData = new FormData();
        formData.append("question", question);
        formData.append("csrfmiddlewaretoken", csrfToken);

        const response = await fetch("", {
            method: "POST",
            body: formData,
            headers: { 'X-CSRFToken': csrfToken }
        });

        const data = await response.json();
        addChatBubble("ai", data.answer);
    }

    // Process all queued questions when online
    async function processQueue() {
        if (!navigator.onLine) return;

        const queue = JSON.parse(localStorage.getItem("offlineQueue") || "[]");
        if (queue.length === 0) return;

        localStorage.removeItem("offlineQueue");

        for (const item of queue) {
            addChatBubble("user", item.question, item.timestamp);
            await sendQuestion(item.question, item.csrfToken);
        }
    }

    form.onsubmit = async function (e) {
        e.preventDefault();
        const formData = new FormData(form);
        const question = formData.get("question");
        const csrfToken = formData.get("csrfmiddlewaretoken");
        const timestamp = new Date().toISOString();

        addChatBubble("user", question, timestamp);
        form.reset();

        if (!navigator.onLine) {
            queueQuestion(question, csrfToken);
            addChatBubble("ai", "You're offline. Your question has been queued.");
            return;
        }

        showLoading();

        try {
            const response = await fetch("", {
                method: "POST",
                body: formData,
                headers: { 'X-CSRFToken': csrfToken }
            });

            const data = await response.json();
            addChatBubble("ai", data.answer);
        } catch (error) {
            addChatBubble("ai", "Error sending message. It has been queued.");
            queueQuestion(question, csrfToken);
        } finally {
            hideLoading();
        }
    };

    const clearChatBtn = document.getElementById("clear-chat");
    clearChatBtn.addEventListener("click", () => {
        chatLog.innerHTML = "";
        localStorage.removeItem("offlineQueue");
    });

    // Sync queued questions on page load and when back online
    window.addEventListener("load", processQueue);
    window.addEventListener("online", processQueue);
</script>


</body>
</html>
